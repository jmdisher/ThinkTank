<!doctype html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<script src="likeness.js"></script>

		<title>Think Tank Chat Room</title>
	</head>
	<body>
		<h1>Think Tank Chat Room</h1>
		<div class="container" id="container">
		</div>
	</body>
	<script>
		// Define the UI templates for types.
		createStringFieldTemplate("string");
		createArrayTemplate("chat", "string");
		createStructTemplate("tuple", 
			new Map([["Chat Room", "chat"], ["Post", "string"]]),
			new Map([["Post", function(map) {
				enqueueOrSend(map.getValue("Post").getValue());
				map.getValue("Post").setValue("");
			}], ["Auth", function(map) {
				fetch("/getid")
					.then(response => response.text())
				;
			}]])
		);
		
		
		// Create empty binding struct and attach it.
		let topData = Likeness.OBSERVABLE_GENERATOR_MAP["tuple"]();
		let container = document.getElementById("container");
		cloneTemplate("tuple", container, "Chat room", topData);
		
		// Kick-off the WebSocket.
		startWebSocket();
		
		var WEB_SOCKET = null;
		var WAITING_TO_SEND = [];
		function startWebSocket() {
			let listener = new WebSocket("ws://localhost:8080/chat", ["text"]);
			listener.onmessage = function(event) {
				let post = Likeness.OBSERVABLE_GENERATOR_MAP["string"]();
				let json = JSON.parse(event.data);
				post.setValue(json.sender + ": " + json.content);
				topData.getValue("Chat Room").addElement(post);
			}
			listener.onopen = function(event) {
				WEB_SOCKET = listener;
				WAITING_TO_SEND.forEach(function(elt, index, array) {
					sendMessage(elt);
				});
				WAITING_TO_SEND = null;
			}
			listener.onclose = function(event) {
				WEB_SOCKET = null;
				WAITING_TO_SEND = [];
				
				// We use 3000 as the status code for missing auth.
				if (3000 == event.code) {
					refreshAuth(startWebSocket);
				} else {
					// Clear the socket and re-open it after a cool-down period (5 seconds).
					let cooldownMillis = 5000;
					window.setTimeout(startWebSocket, cooldownMillis);
				}
			}
		}
		
		function enqueueOrSend(message) {
			if (null != WEB_SOCKET) {
				sendMessage(message);
			} else {
				WAITING_TO_SEND.push(message);
			}
		}
		
		function sendMessage(message) {
			WEB_SOCKET.send(message);
		}
		
		function refreshAuth(callback) {
			fetch("/getid")
				.then(response => {
					if (403 == response.status) {
						alert("ERROR IN AUTH: " + response.statusText);
					} else {
						callback();
					}
				})
			;
		}
	</script>
</html>
